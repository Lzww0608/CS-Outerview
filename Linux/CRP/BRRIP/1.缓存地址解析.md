

## ğŸ“ ç¼“å­˜åœ°å€è§£æï¼šä¸‰æ®µå¼è®¾è®¡

### åœ°å€ç»“æ„ç¤ºä¾‹

å‡è®¾æˆ‘ä»¬æœ‰ï¼š
- **ç¼“å­˜å¤§å°**ï¼š64KB
- **å—å¤§å°**ï¼š64å­—èŠ‚
- **ç›¸è”åº¦**ï¼š8è·¯
- **ç»„æ•°**ï¼š128ç»„ (64KB / 64B / 8è·¯ = 128)

é‚£ä¹ˆä¸€ä¸ª64ä½åœ°å€è¢«åˆ†è§£ä¸ºï¼š

```
å†…å­˜åœ°å€ï¼š0x0000_1234_5678_9ABC

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TAG (52ä½)  â”‚ SET_INDEX (7ä½) â”‚ OFFSET (6ä½)     â”‚
â”‚              â”‚                  â”‚                   â”‚
â”‚  æ ‡è¯†æ˜¯å“ªä¸ªå— â”‚  é€‰æ‹©å“ªä¸ªç»„      â”‚  å—å†…ç¬¬å‡ ä¸ªå­—èŠ‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



### ğŸ¯ ä¸‰éƒ¨åˆ†çš„å…·ä½“ä½œç”¨

#### **1ï¸âƒ£ OFFSETï¼ˆå—å†…åç§»ï¼‰**
```cpp
offset_bits_ = log2(block_size_bytes);  // 64å­—èŠ‚ â†’ 6ä½
```

**ä½œç”¨**ï¼šå®šä½åˆ°å—å†…çš„å…·ä½“å­—èŠ‚

```
ä¾‹å¦‚ï¼šOFFSET = 0b101010 (42)
â†’ è¡¨ç¤ºè¦è®¿é—®è¿™ä¸ªç¼“å­˜å—çš„ç¬¬42ä¸ªå­—èŠ‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Block (64 bytes)              â”‚
â”‚ [0][1][2]...[42]...[63]            â”‚
â”‚              â†‘ è¦è®¿é—®è¿™é‡Œ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆä¸éœ€è¦åœ¨ç¼“å­˜é€»è¾‘ä¸­ä½¿ç”¨ï¼Ÿ**
- ç¼“å­˜æ˜¯ä»¥**æ•´å—**ä¸ºå•ä½ç®¡ç†çš„
- OFFSETåªåœ¨CPUè¯»å–å…·ä½“æ•°æ®æ—¶æ‰ç”¨åˆ°
- ç¼“å­˜æ›¿æ¢ç­–ç•¥ä¸å…³å¿ƒå—å†…å“ªä¸ªå­—èŠ‚

---

#### **2ï¸âƒ£ SET_INDEXï¼ˆç»„ç´¢å¼•ï¼‰**
```cpp
set_index = (address >> offset_bits_) & ((1ULL << set_index_bits_) - 1);
```

**ä½œç”¨**ï¼šå°†å†…å­˜åœ°å€æ˜ å°„åˆ°å…·ä½“çš„ç¼“å­˜ç»„

```
å†…å­˜åœ°å€ç©ºé—´                    ç¼“å­˜ç»„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ 0x0000_xxxx  â”‚â”€â”€â”            â”‚ Set 0â”‚ (8è·¯)
â”‚ 0x0040_xxxx  â”‚  â”‚  Hashæ˜ å°„   â”‚ Set 1â”‚ (8è·¯)
â”‚ 0x0080_xxxx  â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚ Set 2â”‚ (8è·¯)
â”‚ 0x00C0_xxxx  â”‚  â”‚            â”‚  ...  â”‚
â”‚     ...      â”‚â”€â”€â”˜            â”‚Set127â”‚ (8è·¯)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”˜

è®¡ç®—æ–¹å¼ï¼š
address = 0x1234_5680
offset_bits = 6
set_index_bits = 7

set_index = (0x1234_5680 >> 6) & 0b111_1111
         = 0x48D15 & 0x7F
         = 0x15 = 21
â†’ è¿™ä¸ªåœ°å€åº”è¯¥å»ç¬¬21å·ç»„æŸ¥æ‰¾
```

**ä¸ºä»€ä¹ˆéœ€è¦SET_INDEXï¼Ÿ**
- **é™ä½æŸ¥æ‰¾å¤æ‚åº¦**ï¼šä¸éœ€è¦æœç´¢æ•´ä¸ªç¼“å­˜ï¼Œåªæœç´¢ä¸€ä¸ªç»„
- **å‡åŒ€åˆ†å¸ƒ**ï¼šé€šè¿‡åœ°å€ä½ä½å“ˆå¸Œï¼Œè®©ä¸åŒåœ°å€å‡åŒ€åˆ†å¸ƒåˆ°å„ç»„
- **ç»„ç›¸è”**ï¼šåœ¨SET_INDEXç¡®å®šçš„ç»„å†…è¿›è¡Œ8è·¯ï¼ˆæˆ–Nè·¯ï¼‰æŸ¥æ‰¾

---

#### **3ï¸âƒ£ TAGï¼ˆæ ‡ç­¾ï¼‰**
```60:61:CRP/src/BRRIP/brrip_cache.cpp
    set_index = (address >> offset_bits_) & ((1ULL << set_index_bits_) - 1);
    tag = address >> (offset_bits_ + set_index_bits_);
```

**ä½œç”¨**ï¼šåœ¨åŒä¸€ä¸ªç»„å†…åŒºåˆ†ä¸åŒçš„å†…å­˜å—

```
ä¸ºä»€ä¹ˆéœ€è¦TAGï¼Ÿ
å› ä¸ºå¤šä¸ªå†…å­˜åœ°å€ä¼šæ˜ å°„åˆ°åŒä¸€ä¸ªç»„ï¼

ä¾‹å¦‚ï¼šç»„2å¯èƒ½åŒæ—¶ç¼“å­˜è¿™äº›åœ°å€çš„æ•°æ®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Set 2 (8-way)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Way 0  â”‚Validâ”‚ TAG  â”‚ Data[64B]      â”‚
â”‚        â”‚  1  â”‚0x123 â”‚ [...........]   â”‚ â† æ¥è‡ªåœ°å€0x123_002_80
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Way 1  â”‚  1  â”‚0x456 â”‚ [...........]   â”‚ â† æ¥è‡ªåœ°å€0x456_002_80
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Way 2  â”‚  0  â”‚  -   â”‚ [...........]   â”‚ â† ç©ºé—²
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ...   â”‚ ... â”‚ ...  â”‚     ...        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥æ‰¾è¿‡ç¨‹ï¼š
1. SET_INDEX=2 â†’ å®šä½åˆ°ç»„2
2. åœ¨ç»„2çš„8è·¯ä¸­ï¼Œé€ä¸ªæ¯”è¾ƒTAG
3. æ‰¾åˆ°TAG=0x123ä¸”Valid=1 â†’ å‘½ä¸­ï¼
```

æŸ¥æ‰¾ä»£ç å°±ä½“ç°äº†è¿™ä¸ªè¿‡ç¨‹ï¼š

```65:78:CRP/src/BRRIP/brrip_cache.cpp
bool BRRIPCache<RRPV_M_BITS>::access(uint64_t address) {
    uint64_t tag;
    size_t set_index;
    parseAddress(address, tag, set_index);

    assert(set_index < num_sets_ && "Invalid set index");

    auto& target_set = sets_[set_index];
    auto way = target_set.findWay(tag);

    if (way.has_value()) {
        target_set.accessWay(way.value());
        hit_count_.fetch_add(1, std::memory_order_relaxed);
        return true;
```

---

##  Buckets æ•°æ®ç»“æ„çš„ä½œç”¨

è®©æˆ‘æŸ¥çœ‹bucketsçš„å®šä¹‰ï¼š

### ğŸ¯ Bucketsï¼šé«˜æ•ˆçš„RRPVç´¢å¼•ç»“æ„

**å®šä¹‰**ï¼š
```cpp
std::vector<std::vector<size_t>> buckets_;  // buckets[r] å­˜å‚¨æ‰€æœ‰ RRPV=r çš„wayç´¢å¼•
```

**ä½œç”¨**ï¼šå°†ç›¸åŒRRPVå€¼çš„ç¼“å­˜è¡Œç»„ç»‡åœ¨ä¸€èµ·ï¼Œå®ç°O(1)æŸ¥æ‰¾

---

### ğŸ“Š Buckets å·¥ä½œåŸç†å›¾è§£

å‡è®¾ä¸€ä¸ª8è·¯ç»„ç›¸è”ç¼“å­˜ï¼ŒRRPVä½¿ç”¨2ä½ï¼ˆ0-3ï¼‰ï¼š

```
åˆå§‹çŠ¶æ€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ways (å®é™…ç¼“å­˜è¡Œ)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Way0 â”‚Valid â”‚ RRPV â”‚ TAG â”‚ Data                    â”‚
â”‚      â”‚  1   â”‚  0   â”‚0x12 â”‚ [..................]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Way1 â”‚  1   â”‚  2   â”‚0x34 â”‚ [..................]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Way2 â”‚  1   â”‚  0   â”‚0x56 â”‚ [..................]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Way3 â”‚  1   â”‚  3   â”‚0x78 â”‚ [..................]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Way4 â”‚  1   â”‚  1   â”‚0x9A â”‚ [..................]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Way5 â”‚  1   â”‚  3   â”‚0xBC â”‚ [..................]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Way6 â”‚  0   â”‚  -   â”‚  -  â”‚ [..................]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Way7 â”‚  1   â”‚  2   â”‚0xDE â”‚ [..................]    â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯¹åº”çš„ Buckets ç´¢å¼•ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ buckets_[0] = {0, 2}              â”‚ â† RRPV=0çš„wayæœ‰ï¼šWay0, Way2
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ buckets_[1] = {4}                 â”‚ â† RRPV=1çš„wayæœ‰ï¼šWay4
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ buckets_[2] = {1, 7}              â”‚ â† RRPV=2çš„wayæœ‰ï¼šWay1, Way7
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ buckets_[3] = {3, 5}              â”‚ â† RRPV=3çš„wayæœ‰ï¼šWay3, Way5
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾…åŠ©æ•°æ®ï¼š
rrpv_presence = 0b1111 (æ‰€æœ‰RRPVå€¼0-3éƒ½å­˜åœ¨)
max_rrpv = 3           (å½“å‰æœ€å¤§RRPVå€¼)
```

---

### âš¡ Buckets çš„ä¸‰å¤§ä¼˜åŠ¿

#### **1. å¿«é€ŸæŸ¥æ‰¾Victimï¼ˆO(1)å¤æ‚åº¦ï¼‰**

**æ²¡æœ‰bucketsçš„æƒ…å†µ**ï¼š
```cpp
// éœ€è¦éå†æ‰€æœ‰wayï¼Œæ—¶é—´å¤æ‚åº¦O(N)
size_t findVictimWay() {
    uint8_t max_rrpv = 0;
    // ç¬¬ä¸€éï¼šæ‰¾å‡ºæœ€å¤§RRPVå€¼
    for (size_t i = 0; i < ways_.size(); i++) {
        if (ways_[i].valid && ways_[i].rrpv > max_rrpv) {
            max_rrpv = ways_[i].rrpv;
        }
    }
    // ç¬¬äºŒéï¼šæ‰¾å‡ºæ‰€æœ‰RRPVç­‰äºmaxçš„way
    std::vector<size_t> candidates;
    for (size_t i = 0; i < ways_.size(); i++) {
        if (ways_[i].valid && ways_[i].rrpv == max_rrpv) {
            candidates.push_back(i);
        }
    }
    return candidates[rand() % candidates.size()];
}
```

**æœ‰bucketsçš„æƒ…å†µ**ï¼š
```107:113:CRP/src/BRRIP/cache_set.cpp
    // ç°åœ¨max_rrpv == RRPV_MAXï¼Œä»max_rrpv bucketä¸­éšæœºé€‰æ‹©victim
    auto& candidates = buckets_[max_rrpv];
    
    // ä½¿ç”¨C++11éšæœºæ•°ç”Ÿæˆå™¨
    static thread_local std::mt19937 gen(std::random_device{}());
    std::uniform_int_distribution<size_t> dist(0, candidates.size() - 1);
    size_t victim_idx = candidates[dist(gen)];
```

**æ€§èƒ½å¯¹æ¯”**ï¼šO(N) â†’ O(1) âœ¨

---

#### **2. é«˜æ•ˆçš„RRPVæ›´æ–°**

å½“è®¿é—®å‘½ä¸­æ—¶ï¼Œéœ€è¦å°†æŸä¸ªwayçš„RRPVä»æ—§å€¼æ”¹ä¸º0ï¼š

```130:154:CRP/src/BRRIP/cache_set.cpp
void CacheSet<RRPV_M_BITS>::accessWay(size_t way_index) {
    // write lock
    std::unique_lock<std::shared_mutex> writeLock(*mtx_);
    auto& line = ways_[way_index];
    uint8_t old_rrpv = line.rrpv;
    line.rrpv = 0; // reset to 0
    line.valid = true;

    // remove from old bucket, add to bucket '0'
    auto& old_bucket = buckets_[old_rrpv];
    old_bucket.erase(std::remove(old_bucket.begin(), old_bucket.end(), way_index), old_bucket.end());
    if (old_bucket.empty()) {
        rrpv_presence &= ~(1 << old_rrpv);
        // if old_rrpv == max_rrpv, update
        if (old_rrpv == max_rrpv) {
            while (max_rrpv > 0 && !(rrpv_presence & (1 << max_rrpv))) {
                max_rrpv--;
            }
        }
    }

    buckets_[0].push_back(way_index);
    rrpv_presence |= 1;
    max_rrpv = std::max<uint8_t>(0, max_rrpv);
}
```

**æ“ä½œæµç¨‹**ï¼š
```
1. ä»æ—§bucketä¸­ç§»é™¤wayç´¢å¼•
2. æ·»åŠ åˆ°æ–°bucket
3. æ›´æ–°ä½å›¾æ ‡è®°
```

---

#### **3. æ‰¹é‡Age-Upæ“ä½œ**

RRPVçš„æ ¸å¿ƒç‰¹æ€§ï¼šå½“æ²¡æœ‰RRPV=MAXçš„è¡Œæ—¶ï¼Œæ‰€æœ‰è¡Œçš„RRPVè¦é€’å¢ï¼š

```85:105:CRP/src/BRRIP/cache_set.cpp
    // RRPV Age-Upæœºåˆ¶ï¼šå¦‚æœmax_rrpv < RRPV_MAXï¼Œé€’å¢æ‰€æœ‰è¡Œçš„RRPVç›´åˆ°æœ‰è¡Œè¾¾åˆ°RRPV_MAX
    while (max_rrpv < RRPV_MAX) {
        // éå†æ‰€æœ‰å½“å‰max_rrpvçš„è¡Œï¼Œå°†å®ƒä»¬çš„RRPVé€’å¢
        for (uint8_t rrpv = 0; rrpv <= max_rrpv; ++rrpv) {
            auto& bucket = buckets_[rrpv];
            if (!bucket.empty()) {
                // å°†è¿™ä¸ªbucketä¸­çš„æ‰€æœ‰wayç§»åŠ¨åˆ°rrpv+1
                auto& next_bucket = buckets_[rrpv + 1];
                for (size_t way_idx : bucket) {
                    ways_[way_idx].rrpv++;
                    next_bucket.push_back(way_idx);
                }
                // æ›´æ–°ä½å›¾
                rrpv_presence |= (1 << (rrpv + 1));
                // æ¸…ç©ºå½“å‰bucket
                bucket.clear();
                rrpv_presence &= ~(1 << rrpv);
            }
        }
        max_rrpv++;
    }
```

**åŠ¨ç”»æ¼”ç¤º**ï¼š
```
Age-Upå‰ï¼šmax_rrpv=2, RRPV_MAX=3
buckets_[0] = {0, 2}
buckets_[1] = {4}
buckets_[2] = {1, 7}
buckets_[3] = {}      â† ç©ºçš„ï¼éœ€è¦Age-Up

Age-Upåï¼šmax_rrpv=3
buckets_[0] = {}
buckets_[1] = {0, 2}  â† ä»bucket[0]ç§»è¿‡æ¥
buckets_[2] = {4}     â† ä»bucket[1]ç§»è¿‡æ¥
buckets_[3] = {1, 7}  â† ä»bucket[2]ç§»è¿‡æ¥ï¼Œç°åœ¨å¯ä»¥é©±é€äº†ï¼
```

---

## ğŸ“ æ€»ç»“å¯¹æ¯”è¡¨

| æ¦‚å¿µ          | ä½œç”¨           | ç±»æ¯”                     |
| ------------- | -------------- | ------------------------ |
| **OFFSET**    | å®šä½å—å†…å­—èŠ‚   | ğŸ“– ä¹¦çš„ç¬¬å‡ é¡µçš„ç¬¬å‡ è¡Œ     |
| **SET_INDEX** | é€‰æ‹©ç¼“å­˜ç»„     | ğŸ—„ï¸ æ–‡ä»¶æŸœçš„ç¬¬å‡ ä¸ªæŠ½å±‰     |
| **TAG**       | åŒºåˆ†åŒç»„å†…çš„å— | ğŸ·ï¸ æŠ½å±‰é‡Œæ¯ä¸ªæ–‡ä»¶å¤¹çš„æ ‡ç­¾ |
| **Buckets**   | RRPVå€¼ç´¢å¼•     | ğŸ“Š æŒ‰ä¼˜å…ˆçº§åˆ†ç±»çš„ä»»åŠ¡åˆ—è¡¨ |

**æŸ¥æ‰¾æµç¨‹å®Œæ•´ç¤ºæ„**ï¼š
```
å†…å­˜åœ°å€ 0x1234_5680
    â†“ parseAddress()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚TAG=0x123â”‚SET_INDEX=21â”‚OFFSET=0â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    è®¿é—®ç¬¬21å·ç»„ï¼ˆ8è·¯ï¼‰
           â†“
    é€è·¯æ¯”è¾ƒTAG
           â†“
    æ‰¾åˆ°TAG=0x123çš„way â†’ å‘½ä¸­ï¼
           â†“
    accessWay() â†’ æ›´æ–°buckets
    å°†è¯¥wayä»buckets_[old_rrpv]ç§»åˆ°buckets_[0]
```

è¿™ç§è®¾è®¡æ—¢ä¿è¯äº†ç¼“å­˜æŸ¥æ‰¾çš„æ•ˆç‡ï¼Œåˆä¼˜åŒ–äº†æ›¿æ¢ç­–ç•¥çš„æ€§èƒ½ï¼ğŸš€